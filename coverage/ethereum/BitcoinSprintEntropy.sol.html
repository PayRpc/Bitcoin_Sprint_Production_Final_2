<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for ethereum\BitcoinSprintEntropy.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">ethereum/</a> BitcoinSprintEntropy.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">60% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>51/85</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">48.57% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>68/140</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">45.83% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">62.39% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>68/109</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">66×</span>
<span class="cline-any cline-yes">66×</span>
<span class="cline-any cline-yes">66×</span>
<span class="cline-any cline-yes">66×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.30;
&nbsp;
/**
 * @title BitcoinSprintEntropy
 * @dev High-performance entropy-request contract optimized for fast backend processing.
 * - Uses two-party fair commit-reveal for unbiased entropy generation
 * - Optimized for 30-second fulfillment timeout (configurable 10s-1h)
 * - Direct refund transfers (no escrow) for speed
 * - Streamlined validation in revealAndFulfill for minimal latency
 * - Keeps payments in contract (escrow accounting) until fulfillment or refund
 * - Adds Pausable, Ownable and ReentrancyGuard
 *
 * Note: this contract uses fair commit-reveal where both user and fulfiller commit,
 * then reveal to derive final entropy hash. Preimages are revealed on-chain for verification
 * but only the final hash is stored/emitted. This ensures entropy unpredictability.
 */
&nbsp;
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
&nbsp;
contract BitcoinSprintEntropy is Ownable, Pausable, ReentrancyGuard {
    // Errors (cheaper than revert strings on L2)
    error InvalidTier();
    error IncorrectPayment();
    error InvalidCommitment();
    error NotAuthorized();
    error NoPayments();
    error InvalidRequestId();
    error AlreadyFulfilled();
    error AlreadyRefunded();
    error InvalidQualityScore();
    error PreimageMismatch();
    error NotFulfilled();
    error TimeoutNotReached();
    error InvalidAddress();
    error TransferFailed();
    error InvalidTreasury();
    error InvalidTimeout();
&nbsp;
    // Constants and configuration
    // Fixed fee for all entropy requests (user requested single-tier fixed fee)
    uint256 public constant FIXED_PAYMENT = 0.0003 ether;
    uint256 public fulfillmentTimeout = 30; // seconds (30 seconds) - optimized for fast backend
&nbsp;
    // Accounting
    uint256 public requestCount;
    uint256 public fulfilledCount;
    uint256 public pendingBalance;   // total held awaiting fulfillment/refund
    uint256 public treasuryBalance;  // collected and withdrawable by owner to treasury
    uint256 public strayBalance;     // ETH received not tied to requests
    address public treasury;
&nbsp;
    // Reordered for tighter packing: small types first where possible
    struct EntropyRequest {
        uint8 qualityTier; // 1=basic, 2=pro, 3=enterprise
        uint16 qualityScore; // 0..10000 persisted
        bool fulfilled;
        bool refunded;
        address requester;
        uint256 timestamp;
        uint256 fulfilledAt;
        bytes32 userCommit; // user's commitment
        bytes32 fulfillerCommit; // fulfiller's commitment
        bytes32 finalEntropyHash; // keccak256(userPreimage, fulfillerPreimage)
        uint256 payment;
    }
&nbsp;
    mapping(uint256 =&gt; EntropyRequest) private requests;
    mapping(address =&gt; uint256[]) private userRequests;
    mapping(address =&gt; bool) public authorizedFulfillers;
    // Simple pull-escrow for refunds (replacement for OpenZeppelin PullPayment)
    mapping(address =&gt; uint256) private _escrow;
&nbsp;
    // Events
    event EntropyRequested(uint256 indexed requestId, address indexed requester, uint256 payment, uint8 qualityTier, bytes32 userCommit);
    event EntropyFulfilled(uint256 indexed requestId, address indexed fulfiller, bytes32 indexed finalEntropyHash, uint256 qualityScore);
    event RefundIssued(uint256 indexed requestId, address requester, uint256 amount);
    event TreasuryUpdated(address indexed oldTreasury, address indexed newTreasury);
    event AuthorizedFulfillerAdded(address indexed fulfiller);
    event AuthorizedFulfillerRemoved(address indexed fulfiller);
    event TreasuryWithdrawn(uint256 amount, address to);
&nbsp;
    // Modifiers
    modifier onlyAuthorizedFulfiller() {
        if (!(authorizedFulfillers[msg.sender] || msg.sender == owner())) revert NotAuthorized();
        _;
    }
&nbsp;
    constructor(address _treasury) Ownable(msg.sender) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_treasury == address(0)) revert InvalidTreasury();
        treasury = _treasury;
        authorizedFulfillers[msg.sender] = true;
        emit AuthorizedFulfillerAdded(msg.sender);
    }
&nbsp;
    // Public API
    /// @notice Request entropy by submitting a commitment (keccak256(preimage)). Funds remain in-contract.
    function requestEntropy(uint8 qualityTier, bytes32 userCommit) external payable <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant returns (uint256) {
        if (qualityTier &lt; 1 || qualityTier &gt; 3) revert InvalidTier();
        // All tiers use a single fixed fee
        if (msg.value != FIXED_PAYMENT) revert IncorrectPayment();
        if (userCommit == bytes32(0)) revert InvalidCommitment();
&nbsp;
        uint256 requestId = ++requestCount;
        // minimize storage writes by writing the struct in a single assignment
        requests[requestId] = EntropyRequest({
            qualityTier: qualityTier,
            qualityScore: 0,
            fulfilled: false,
            refunded: false,
            requester: msg.sender,
            timestamp: block.timestamp,
            fulfilledAt: 0,
            userCommit: userCommit,
            fulfillerCommit: bytes32(0),
            finalEntropyHash: bytes32(0),
            payment: msg.value
        });
&nbsp;
        userRequests[msg.sender].push(requestId);
        pendingBalance += msg.value;
&nbsp;
        emit EntropyRequested(requestId, msg.sender, msg.value, qualityTier, userCommit);
        return requestId;
    }
&nbsp;
    /// @notice Returns required payment for a given tier. Currently all tiers use a fixed fee.
<span class="fstat-no" title="function not covered" >    function getRequiredPayment(uint8 /* qualityTier */) external pure returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return FIXED_PAYMENT;</span>
    }
&nbsp;
    /// @notice Fulfiller commits to their entropy contribution.
    function postFulfillerCommit(uint256 requestId, bytes32 fulfillerCommit) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyAuthorizedFulfiller <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (requestId == 0 || requestId &gt; requestCount) revert InvalidRequestId();
        EntropyRequest storage r = requests[requestId];
        <span class="missing-if-branch" title="if path not taken" >I</span>if (r.fulfilled || r.refunded) revert AlreadyFulfilled(); // or specific error
        <span class="missing-if-branch" title="if path not taken" >I</span>if (r.fulfillerCommit != bytes32(0)) revert AlreadyFulfilled(); // already committed
        r.fulfillerCommit = fulfillerCommit;
    }
&nbsp;
    /// @notice Reveal both preimages and fulfill the request, deriving final entropy.
    /// @dev Preimages are revealed on-chain for verification but final hash is stored.
    function revealAndFulfill(
        uint256 requestId,
        bytes32 userPreimage,
        bytes32 fulfillerPreimage,
        uint256 qualityScore
    ) external onlyAuthorizedFulfiller <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        if (<span class="branch-0 cbranch-no" title="branch not covered" >requestId == 0</span> || requestId &gt; requestCount) revert InvalidRequestId();
        EntropyRequest storage r = requests[requestId];
        if (r.fulfilled) revert AlreadyFulfilled();
        if (r.refunded) revert AlreadyRefunded();
        if (qualityScore &gt; 10000) revert InvalidQualityScore();
&nbsp;
        // Optimized: Single combined validation for both preimages
        bytes32 computedUserCommit = keccak256(abi.encodePacked(userPreimage));
        bytes32 computedFulfillerCommit = keccak256(abi.encodePacked(fulfillerPreimage));
&nbsp;
        if (r.userCommit != bytes32(0) &amp;&amp; computedUserCommit != r.userCommit) revert PreimageMismatch();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (computedFulfillerCommit != r.fulfillerCommit) revert PreimageMismatch();
&nbsp;
        // Derive final entropy hash
        r.finalEntropyHash = keccak256(abi.encodePacked(userPreimage, fulfillerPreimage));
&nbsp;
        // Optimized: Batch state updates to minimize SSTORE operations
        r.fulfilled = true;
        r.qualityScore = uint16(qualityScore);
        r.fulfilledAt = block.timestamp;
        fulfilledCount += 1;
&nbsp;
        // Optimized: Single balance transfer operation
        uint256 amt = r.payment;
        <span class="missing-if-branch" title="else path not taken" >E</span>if (amt &gt; 0) {
            pendingBalance -= amt;
            treasuryBalance += amt;
        }
&nbsp;
        // Emit final entropy hash for audit — preimages are revealed but not stored
        emit EntropyFulfilled(requestId, msg.sender, r.finalEntropyHash, qualityScore);
    }
&nbsp;
    /// @notice Allows requester to schedule a refund if fulfillment timeout has passed.
    function requestRefund(uint256 requestId) external <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        if (<span class="branch-0 cbranch-no" title="branch not covered" >requestId == 0</span> || requestId &gt; requestCount) revert InvalidRequestId();
        EntropyRequest storage r = requests[requestId];
        if (r.requester != msg.sender) revert NotAuthorized();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (r.fulfilled) revert AlreadyFulfilled();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (r.refunded) revert AlreadyRefunded();
        if (block.timestamp &lt; r.timestamp + fulfillmentTimeout) revert TimeoutNotReached();
&nbsp;
        // Optimized: Mark as refunded and transfer directly (no escrow for fast backend)
        r.refunded = true;
        uint256 refundAmount = r.payment;
        <span class="missing-if-branch" title="else path not taken" >E</span>if (refundAmount &gt; 0) {
            pendingBalance -= refundAmount;
            // Direct transfer for speed (backend is fast, low risk of stuck funds)
            (bool ok, ) = payable(msg.sender).call{value: refundAmount}("");
            <span class="missing-if-branch" title="if path not taken" >I</span>if (!ok) revert TransferFailed();
        }
&nbsp;
        emit RefundIssued(requestId, r.requester, refundAmount);
    }
&nbsp;
    // View helpers
    /// @notice Returns the stored final entropy hash for a request. Note: this is NOT the raw entropy.
    function getEntropyCommitment(uint256 requestId) external view returns (bytes32) {
        if (<span class="branch-0 cbranch-no" title="branch not covered" >requestId == 0</span> || requestId &gt; requestCount) revert InvalidRequestId();
        EntropyRequest storage r = requests[requestId];
        if (!r.fulfilled) revert NotFulfilled();
        <span class="missing-if-branch" title="else path not taken" >E</span>if (!(r.requester == msg.sender || msg.sender == owner())) revert NotAuthorized();
<span class="cstat-no" title="statement not covered" >        return r.finalEntropyHash;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function canRefund(uint256 requestId) external view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        if (requestId == 0 || requestId &gt; requestCount) <span class="cstat-no" title="statement not covered" >return false;</span></span>
<span class="cstat-no" title="statement not covered" >        EntropyRequest storage r = requests[requestId];</span>
<span class="cstat-no" title="statement not covered" >        if (r.fulfilled || r.refunded) <span class="cstat-no" title="statement not covered" >return false;</span></span>
<span class="cstat-no" title="statement not covered" >        return block.timestamp &gt;= r.timestamp + fulfillmentTimeout;</span>
    }
<span class="fstat-no" title="function not covered" >    function getUserRequests(address user) external view returns (uint256[] memory) {</span>
<span class="cstat-no" title="statement not covered" >        return userRequests[user];</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getContractStats() external view returns (uint256 totalRequests, uint256 totalFulfilled, uint256 contractBalance, uint256 pending, uint256 treasuryReserve, uint256 stray) {</span>
<span class="cstat-no" title="statement not covered" >        return (requestCount, fulfilledCount, address(this).balance, pendingBalance, treasuryBalance, strayBalance);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getRequestMeta(uint256 id)</span>
        external view
        returns (address requester, uint256 timestamp, uint8 qualityTier, bool fulfilled, bool refunded, uint256 payment)
    {
<span class="cstat-no" title="statement not covered" >        if (id == 0 || id &gt; requestCount) revert InvalidRequestId();</span>
<span class="cstat-no" title="statement not covered" >        EntropyRequest storage r = requests[id];</span>
<span class="cstat-no" title="statement not covered" >        return (r.requester, r.timestamp, r.qualityTier, r.fulfilled, r.refunded, r.payment);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function escrowBalanceOf(address a) external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return _escrow[a];</span>
    }
&nbsp;
    /// @notice Sweep stray ETH to treasury (owner only)
<span class="fstat-no" title="function not covered" >    function sweepStray() external onlyOwner nonReentrant {</span>
<span class="cstat-no" title="statement not covered" >        uint256 amt = strayBalance;</span>
<span class="cstat-no" title="statement not covered" >        if (amt == 0) revert NoPayments();</span>
        strayBalance = 0;
<span class="cstat-no" title="statement not covered" >        (bool ok, ) = treasury.call{value: amt}("");</span>
<span class="cstat-no" title="statement not covered" >        if (!ok) revert TransferFailed();</span>
<span class="cstat-no" title="statement not covered" >        emit TreasuryWithdrawn(amt, treasury);</span>
    }
&nbsp;
    // Admin functions
    function addAuthorizedFulfiller(address fulfiller) external onlyOwner {
        <span class="missing-if-branch" title="else path not taken" >E</span>if (fulfiller == address(0)) revert InvalidAddress();
        authorizedFulfillers[fulfiller] = true;
<span class="cstat-no" title="statement not covered" >        emit AuthorizedFulfillerAdded(fulfiller);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function removeAuthorizedFulfiller(address fulfiller) external onlyOwner {</span>
        authorizedFulfillers[fulfiller] = false;
<span class="cstat-no" title="statement not covered" >        emit AuthorizedFulfillerRemoved(fulfiller);</span>
    }
&nbsp;
    function updateTreasury(address newTreasury) external onlyOwner {
        if (newTreasury == address(0)) revert InvalidAddress();
        address old = treasury;
        treasury = newTreasury;
        emit TreasuryUpdated(old, newTreasury);
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function updateFulfillmentTimeout(uint256 newTimeout) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if (newTimeout &lt; 10 || newTimeout &gt; 3600) revert InvalidTimeout();</span>
        fulfillmentTimeout = newTimeout;
    }
&nbsp;
    /// @notice Withdraw accumulated treasury reserves to the configured treasury address
    function withdrawTreasury() external onlyOwner <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        uint256 amt = treasuryBalance;
        if (amt == 0) revert NoPayments();
        treasuryBalance = 0;
        (bool ok, ) = treasury.call{value: amt}("");
        <span class="missing-if-branch" title="else path not taken" >E</span>if (!ok) revert TransferFailed();
<span class="cstat-no" title="statement not covered" >        emit TreasuryWithdrawn(amt, treasury);</span>
    }
&nbsp;
    /// @notice Owner-triggered batch release of scheduled refunds (PullPayment is owner-gated).
<span class="fstat-no" title="function not covered" >    function releaseRefunds(address[] calldata payees) external onlyOwner nonReentrant {</span>
<span class="cstat-no" title="statement not covered" >        uint256 n = payees.length;</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; n; i++) {</span>
<span class="cstat-no" title="statement not covered" >            address payee = payees[i];</span>
<span class="cstat-no" title="statement not covered" >            uint256 amount = _escrow[payee];</span>
<span class="cstat-no" title="statement not covered" >            if (amount &gt; 0) {</span>
                _escrow[payee] = 0;
<span class="cstat-no" title="statement not covered" >                (bool ok, ) = payable(payee).call{value: amount}("");</span>
                // if transfer fails, restore escrow balance
<span class="cstat-no" title="statement not covered" >                if (!ok) {</span>
                    _escrow[payee] = amount;
                }
            }
        }
    }
&nbsp;
    /// @notice Withdraw your scheduled refunds from escrow.
    function withdrawPayments() external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        uint256 payment = _escrow[msg.sender];
        <span class="missing-if-branch" title="else path not taken" >E</span>if (payment == 0) revert NoPayments();
        _escrow[msg.sender] = 0;
<span class="cstat-no" title="statement not covered" >        (bool ok, ) = payable(msg.sender).call{value: payment}("");</span>
<span class="cstat-no" title="statement not covered" >        if (!ok) revert TransferFailed();</span>
    }
&nbsp;
    // Pause/Unpause
<span class="fstat-no" title="function not covered" >    function pause() external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        _pause()</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function unpause() external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        _unpause()</span>;
    }
&nbsp;
    // Receive fallback — allow contract to accept ETH (e.g., refunds scheduled to escrow)
    receive() external payable {
        strayBalance += msg.value;
    }
<span class="fstat-no" title="function not covered" >    fallback() external payable {</span>
        strayBalance += msg.value;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Sep 07 2025 17:17:31 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
